#cloud-config
# MongoDB Installation and Configuration via Cloud-Init

write_files:
    - path: /opt/mongodb-setup.sh
      permissions: '0755'
      content: |
          #!/bin/bash
          set -e
          
          # Terraform Variables
          MONGODB_VERSION="${mongodb_version}"
          REPLICA_SET_NAME="${replica_set_name}"
          NODE_INDEX="${node_index}"
          TOTAL_NODES="${total_nodes}"
          ADMIN_USERNAME="${mongodb_admin_username}"
          ADMIN_PASSWORD="${mongodb_admin_password}"
          KEYFILE_CONTENT="${mongodb_keyfile_content}"
          ENABLE_MONITORING="${enable_monitoring}"
          DATA_VOLUME_DEVICE="${data_volume_device}"
          CLUSTER_NAME="${cluster_name}"
          
          # Log everything
          exec > >(tee /var/log/mongodb-setup.log)
          exec 2>&1
          
          echo "### Starting MongoDB setup ###"
          echo "Version: $MONGODB_VERSION, Replica Set: $REPLICA_SET_NAME"
          
          apt-get update
          apt-get upgrade -y
          apt-get install -y gnupg curl wget software-properties-common lsb-release xfsprogs
          
          # Add MongoDB GPG key and repo
          curl -fsSL https://www.mongodb.org/static/pgp/server-$${MONGODB_VERSION}.asc | gpg --dearmor -o /usr/share/keyrings/mongodb.gpg
          echo "deb [ arch=amd64 signed-by=/usr/share/keyrings/mongodb.gpg ] https://repo.mongodb.org/apt/ubuntu $(lsb_release -cs)/mongodb-org/$${MONGODB_VERSION} multiverse" | tee /etc/apt/sources.list.d/mongodb-org-$${MONGODB_VERSION}.list
          
          apt-get update
          apt-get install -y mongodb-org
          
          # Install CloudWatch Agent if enabled
          if [ "$ENABLE_MONITORING" = "true" ]; then
            wget https://s3.amazonaws.com/amazoncloudwatch-agent/ubuntu/amd64/latest/amazon-cloudwatch-agent.deb
            dpkg -i ./amazon-cloudwatch-agent.deb
            rm -f ./amazon-cloudwatch-agent.deb
          fi
          
          echo "Detecting EBS volume..."
          find_data_device() {
            # List devices for debugging
            echo "Available block devices:" >&2
            lsblk >&2
          
            for device in /dev/nvme*n1; do
              if [ -e "$device" ] && ! mount | grep -q "$device" && ! lsblk "$device" | grep -q "/"; then
                echo "$device"
                return 0
              fi
            done
          
            for device in /dev/xvd[f-z] /dev/sd[f-z]; do
              if [ -e "$device" ] && ! mount | grep -q "$device"; then
                echo "$device"
                return 0
              fi
            done
            return 1
          }
          
          # Wait up to 5 minutes for volume
          echo "Waiting for data volume..."
          MAX_WAIT=300
          WAITED=0
          DATA_DEVICE=""
          while [ $WAITED -lt $MAX_WAIT ]; do
            if DATA_DEVICE=$(find_data_device); then
              break
            fi
            sleep 5
            WAITED=$((WAITED + 5))
          done
          
          if [ -z "$DATA_DEVICE" ]; then
            echo "ERROR: No data volume found"
            lsblk
            exit 1
          fi
          
          echo "Using device: $DATA_DEVICE"
          
          # Format if needed
          if ! blkid "$DATA_DEVICE"; then
            echo "Formatting $DATA_DEVICE with XFS..."
            mkfs.xfs "$DATA_DEVICE"
          else
            echo "Device already formatted"
          fi
          
          mkdir -p /data/mongodb
          mount "$DATA_DEVICE" /data/mongodb
          
          UUID=$(blkid -s UUID -o value "$DATA_DEVICE")
          echo "UUID=$UUID /data/mongodb xfs defaults,nofail 0 2" >> /etc/fstab
          
          chown -R mongodb:mongodb /data/mongodb
          mkdir -p /data/mongodb/{db,logs}
          chown -R mongodb:mongodb /data/mongodb
          
          if [ -n "$KEYFILE_CONTENT" ]; then
            echo "$KEYFILE_CONTENT" > /etc/mongodb-keyfile
            chmod 400 /etc/mongodb-keyfile
            chown mongodb:mongodb /etc/mongodb-keyfile
          fi
          
          cat > /etc/mongod.conf <<EOF
          storage:
            dbPath: /data/mongodb/db
            engine: wiredTiger
            wiredTiger:
              engineConfig:
                cacheSizeGB: 2
          
          systemLog:
            destination: file
            logAppend: true
            path: /data/mongodb/logs/mongod.log
          
          net:
            port: 27017
            bindIp: 0.0.0.0
          
          processManagement:
            timeZoneInfo: /usr/share/zoneinfo
          
          replication:
            replSetName: $REPLICA_SET_NAME
          
          security:
            authorization: enabled
          EOF
          
          if [ -n "$KEYFILE_CONTENT" ]; then
            echo "  keyFile: /etc/mongodb-keyfile" >> /etc/mongod.conf
          fi
          
          systemctl daemon-reload
          systemctl enable mongod
          systemctl start mongod
          sleep 10
          
          if ! systemctl is-active --quiet mongod; then
            echo "ERROR: MongoDB failed to start"
            systemctl status mongod
            tail -n 50 /data/mongodb/logs/mongod.log
            exit 1
          fi
          
          # Replica set init
          if [ "$NODE_INDEX" = "0" ]; then
            echo "Initializing replica set..."
            sleep 15
            PRIVATE_IP=$(curl -s http://169.254.169.254/latest/meta-data/local-ipv4)
          
            # Use mongosh for MongoDB 8.0 (newer versions)
            MONGO_CLI=$(command -v mongosh || command -v mongo)
          
            $MONGO_CLI --eval "
            rs.initiate({
              _id: '$REPLICA_SET_NAME',
              members: [{ _id: 0, host: '$PRIVATE_IP:27017', priority: 2 }]
            })
            "
          
            sleep 15
          
            echo "Creating admin user..."
            $MONGO_CLI admin --eval "
            db.createUser({
              user: '$ADMIN_USERNAME',
              pwd: '$ADMIN_PASSWORD',
              roles: [
                { role: 'root', db: 'admin' },
                { role: 'clusterAdmin', db: 'admin' }
              ]
            })
            "
          fi
          
          echo "MongoDB setup complete!"
          systemctl status mongod --no-pager
          ss -tln | grep 27017

runcmd:
    - bash /opt/mongodb-setup.sh

final_message: "âœ… MongoDB installation and configuration completed!"