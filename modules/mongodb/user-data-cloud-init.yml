#cloud-config
# MongoDB Installation and Configuration - FIXED Region and Discovery

write_files:
    - path: /opt/mongodb-setup.sh
      permissions: '0755'
      content: |
          #!/bin/bash
          set -e
          
          # Terraform Variables
          MONGODB_VERSION="${mongodb_version}"
          REPLICA_SET_NAME="${replica_set_name}"
          NODE_INDEX="${node_index}"
          TOTAL_NODES="${total_nodes}"
          ADMIN_USERNAME="${mongodb_admin_username}"
          ADMIN_PASSWORD="${mongodb_admin_password}"
          KEYFILE_CONTENT="${mongodb_keyfile_content}"
          ENABLE_MONITORING="${enable_monitoring}"
          DATA_VOLUME_DEVICE="${data_volume_device}"
          CLUSTER_NAME="${cluster_name}"
          VPC_ID="${vpc_id}"
          
          # Log everything
          exec > >(tee /var/log/mongodb-setup.log)
          exec 2>&1
          
          echo "### Starting MongoDB setup ###"
          echo "Version: $MONGODB_VERSION, Replica Set: $REPLICA_SET_NAME, Node: $NODE_INDEX"
          echo "Total nodes: $TOTAL_NODES"
          
          # FIXED: Better region detection and AWS CLI setup
          get_region() {
            # Try multiple methods to get the region
            local region=""
          
            # Method 1: Instance metadata (most reliable)
            region=$(curl -s --max-time 10 http://169.254.169.254/latest/meta-data/placement/region 2>/dev/null || echo "")
          
            if [ -n "$region" ] && [ "$region" != "" ]; then
              echo "Found region via metadata: $region" >&2
              echo "$region"
              return 0
            fi
          
            # Method 2: Availability zone metadata
            local az=$(curl -s --max-time 10 http://169.254.169.254/latest/meta-data/placement/availability-zone 2>/dev/null || echo "")
            if [ -n "$az" ] && [ "$az" != "" ]; then
              # Extract region from AZ (remove last character)
              region=$${az%?}
              echo "Found region via AZ: $region" >&2
              echo "$region"
              return 0
            fi
          
            # Method 3: Fallback to hardcoded region for this deployment
            region="us-east-1"
            echo "Using fallback region: $region" >&2
            echo "$region"
          }
          
          # Get and validate region
          REGION=$(get_region)
          if [ -z "$REGION" ] || [ "$REGION" = "" ]; then
            echo "ERROR: Could not determine AWS region"
            exit 1
          fi
          
          echo "Using AWS region: $REGION"
          
          # Configure AWS CLI with region
          aws configure set region "$REGION"
          aws configure set default.region "$REGION"
          export AWS_DEFAULT_REGION="$REGION"
          
          # Test AWS CLI connectivity
          echo "Testing AWS CLI connectivity..."
          if ! aws sts get-caller-identity >/dev/null 2>&1; then
            echo "WARNING: AWS CLI test failed, but continuing..."
          else
            echo "AWS CLI connectivity confirmed"
          fi
          
          # Update system
          apt-get update -y
          apt-get upgrade -y
          apt-get install -y gnupg curl wget software-properties-common lsb-release xfsprogs awscli jq netcat-openbsd
          
          # Add MongoDB GPG key and repo
          curl -fsSL https://www.mongodb.org/static/pgp/server-$${MONGODB_VERSION}.asc | gpg --dearmor -o /usr/share/keyrings/mongodb.gpg
          echo "deb [ arch=amd64 signed-by=/usr/share/keyrings/mongodb.gpg ] https://repo.mongodb.org/apt/ubuntu $(lsb_release -cs)/mongodb-org/$${MONGODB_VERSION} multiverse" | tee /etc/apt/sources.list.d/mongodb-org-$${MONGODB_VERSION}.list
          
          apt-get update -y
          apt-get install -y mongodb-org
          
          # Install CloudWatch Agent if enabled
          if [ "$ENABLE_MONITORING" = "true" ]; then
            wget https://s3.amazonaws.com/amazoncloudwatch-agent/ubuntu/amd64/latest/amazon-cloudwatch-agent.deb
            dpkg -i ./amazon-cloudwatch-agent.deb
            rm -f ./amazon-cloudwatch-agent.deb
          fi
          
          # FIXED: Function to discover other MongoDB nodes using EC2 tags
          discover_mongodb_nodes() {
            echo "Discovering MongoDB nodes using EC2 tags in region $REGION..." >&2
          
            # Retry logic for AWS API calls
            local max_retries=3
            local retry_count=0
            local node_ips=""
          
            while [ $retry_count -lt $max_retries ]; do
              echo "Attempt $((retry_count + 1))/$max_retries to discover nodes..." >&2
          
              # Try to get instances with explicit region
              node_ips=$(aws ec2 describe-instances \
                --region "$REGION" \
                --filters \
                  "Name=tag:MongoDBCluster,Values=$CLUSTER_NAME" \
                  "Name=instance-state-name,Values=running" \
                --query 'Reservations[].Instances[].[PrivateIpAddress,Tags[?Key==`NodeIndex`].Value|[0]]' \
                --output text 2>/dev/null | sort -k2 -n | cut -f1 | grep -v '^$' || echo "")
          
              if [ -n "$node_ips" ] && [ "$node_ips" != "" ]; then
                echo "Successfully discovered nodes: $node_ips" >&2
                echo "$node_ips"
                return 0
              fi
          
              echo "Discovery attempt $((retry_count + 1)) failed, retrying in 10 seconds..." >&2
              sleep 10
              retry_count=$((retry_count + 1))
            done
          
            echo "ERROR: Failed to discover nodes after $max_retries attempts" >&2
            return 1
          }
          
          # Volume setup
          echo "Detecting EBS volume..."
          find_data_device() {
            echo "Available block devices:" >&2
            lsblk >&2
          
            for device in /dev/nvme*n1; do
              if [ -e "$device" ] && ! mount | grep -q "$device" && ! lsblk "$device" | grep -q "/"; then
                echo "$device"
                return 0
              fi
            done
          
            for device in /dev/xvd[f-z] /dev/sd[f-z]; do
              if [ -e "$device" ] && ! mount | grep -q "$device"; then
                echo "$device"
                return 0
              fi
            done
            return 1
          }
          
          # Wait for volume attachment
          echo "Waiting for data volume..."
          MAX_WAIT=300
          WAITED=0
          DATA_DEVICE=""
          while [ $WAITED -lt $MAX_WAIT ]; do
            if DATA_DEVICE=$(find_data_device); then
              break
            fi
            sleep 5
            WAITED=$((WAITED + 5))
          done
          
          if [ -z "$DATA_DEVICE" ]; then
            echo "ERROR: No data volume found"
            lsblk
            exit 1
          fi
          
          echo "Using device: $DATA_DEVICE"
          
          # Format and mount
          if ! blkid "$DATA_DEVICE"; then
            echo "Formatting $DATA_DEVICE with XFS..."
            mkfs.xfs "$DATA_DEVICE"
          fi
          
          mkdir -p /data/mongodb
          mount "$DATA_DEVICE" /data/mongodb
          
          UUID=$(blkid -s UUID -o value "$DATA_DEVICE")
          echo "UUID=$UUID /data/mongodb xfs defaults,nofail 0 2" >> /etc/fstab
          
          mkdir -p /data/mongodb/{db,logs}
          chown -R mongodb:mongodb /data/mongodb
          
          # Create keyfile
          if [ -n "$KEYFILE_CONTENT" ]; then
            echo "$KEYFILE_CONTENT" > /etc/mongodb-keyfile
            chmod 400 /etc/mongodb-keyfile
            chown mongodb:mongodb /etc/mongodb-keyfile
          fi
          
          # Get current node IP
          CURRENT_IP=$(curl -s http://169.254.169.254/latest/meta-data/local-ipv4)
          echo "Current node IP: $CURRENT_IP"
          
          # PHASE 1: Start MongoDB without authentication
          echo "=== PHASE 1: Starting MongoDB without authentication ==="
          cat > /etc/mongod.conf <<EOF
          storage:
            dbPath: /data/mongodb/db
            engine: wiredTiger
            wiredTiger:
              engineConfig:
                cacheSizeGB: 1
          
          systemLog:
            destination: file
            logAppend: true
            path: /data/mongodb/logs/mongod.log
          
          net:
            port: 27017
            bindIp: 0.0.0.0
          
          processManagement:
            timeZoneInfo: /usr/share/zoneinfo
          
          replication:
            replSetName: $REPLICA_SET_NAME
          EOF
          
          systemctl daemon-reload
          systemctl enable mongod
          systemctl start mongod
          
          sleep 15
          
          if ! systemctl is-active --quiet mongod; then
            echo "ERROR: MongoDB failed to start"
            systemctl status mongod
            tail -n 50 /data/mongodb/logs/mongod.log
            exit 1
          fi
          
          MONGO_CLI=$(command -v mongosh 2>/dev/null || command -v mongo)
          
          # PHASE 2: Initialize replica set (only on primary)
          if [ "$NODE_INDEX" = "0" ]; then
            echo "=== PHASE 2: Initializing replica set on primary ==="
          
            # Wait for all nodes to be discoverable and running
            echo "Waiting for all nodes to be ready..."
            while true; do
              if NODE_IPS=$(discover_mongodb_nodes); then
                NODE_COUNT=$(echo "$NODE_IPS" | wc -w)
          
                echo "DEBUG: Found IPs: '$NODE_IPS'"
                echo "DEBUG: Node count: $NODE_COUNT"
          
                if [ "$NODE_COUNT" -eq "$TOTAL_NODES" ]; then
                  echo "All $TOTAL_NODES nodes are discoverable"
                  break
                else
                  echo "Found $NODE_COUNT nodes, waiting for $TOTAL_NODES..."
                fi
              else
                echo "Node discovery failed, retrying..."
              fi
              sleep 15
            done
          
            # Test connectivity to all nodes
            echo "Testing connectivity to all nodes..."
            for ip in $NODE_IPS; do
              if [ "$ip" != "$CURRENT_IP" ]; then
                echo "Testing connection to $ip..."
                while ! nc -z "$ip" 27017; do
                  echo "Waiting for MongoDB on $ip..."
                  sleep 10
                done
                echo "Node $ip is ready"
              fi
            done
          
            # Initialize replica set with all nodes
            echo "Initializing replica set with all nodes..."
            MEMBERS=""
            ID=0
            for ip in $NODE_IPS; do
              if [ $ID -eq 0 ]; then
                MEMBERS="{ _id: $ID, host: '$ip:27017', priority: 2 }"
              else
                MEMBERS="$MEMBERS, { _id: $ID, host: '$ip:27017', priority: 1 }"
              fi
              ID=$((ID + 1))
            done
          
            echo "Replica set members: $MEMBERS"
          
            $MONGO_CLI --eval "
            rs.initiate({
              _id: '$REPLICA_SET_NAME',
              members: [ $MEMBERS ]
            })
            " || {
              echo "Failed to initialize replica set"
              tail -n 20 /data/mongodb/logs/mongod.log
              exit 1
            }
          
            echo "Waiting for replica set to initialize..."
            sleep 30
          
            # Wait for replica set to be ready
            RETRY_COUNT=0
            while [ $RETRY_COUNT -lt 20 ]; do
              if $MONGO_CLI --eval "rs.status()" | grep -q "PRIMARY\|SECONDARY"; then
                echo "Replica set is ready!"
                break
              fi
              echo "Waiting for replica set to be ready... (attempt $((RETRY_COUNT + 1))/20)"
              sleep 15
              RETRY_COUNT=$((RETRY_COUNT + 1))
            done
          
            if [ $RETRY_COUNT -eq 20 ]; then
              echo "ERROR: Replica set failed to initialize properly"
              $MONGO_CLI --eval "rs.status()" || true
              exit 1
            fi
          
            echo "Creating admin user..."
            $MONGO_CLI admin --eval "
            db.createUser({
              user: '$ADMIN_USERNAME',
              pwd: '$ADMIN_PASSWORD',
              roles: [
                { role: 'root', db: 'admin' },
                { role: 'clusterAdmin', db: 'admin' },
                { role: 'userAdminAnyDatabase', db: 'admin' },
                { role: 'dbAdminAnyDatabase', db: 'admin' },
                { role: 'readWriteAnyDatabase', db: 'admin' }
              ]
            })
            " || {
              echo "Failed to create admin user"
              exit 1
            }
          
            echo "Primary setup complete, signaling other nodes..."
            # Signal that primary is ready
            aws ssm put-parameter \
              --region "$REGION" \
              --name "/$CLUSTER_NAME/mongodb/primary-ready" \
              --value "true" \
              --type "String" \
              --overwrite || true
          
          else
            echo "=== PHASE 2: Secondary node waiting for primary ==="
            # Wait for primary to signal it's ready
            while ! aws ssm get-parameter --region "$REGION" --name "/$CLUSTER_NAME/mongodb/primary-ready" >/dev/null 2>&1; do
              echo "Waiting for primary node to complete setup..."
              sleep 30
            done
          
            echo "Primary is ready, continuing with secondary setup..."
            sleep 60
          fi
          
          # PHASE 3: Enable authentication on all nodes
          echo "=== PHASE 3: Enabling authentication ==="
          cat > /etc/mongod.conf <<EOF
          storage:
            dbPath: /data/mongodb/db
            engine: wiredTiger
            wiredTiger:
              engineConfig:
                cacheSizeGB: 1
          
          systemLog:
            destination: file
            logAppend: true
            path: /data/mongodb/logs/mongod.log
          
          net:
            port: 27017
            bindIp: 0.0.0.0
          
          processManagement:
            timeZoneInfo: /usr/share/zoneinfo
          
          replication:
            replSetName: $REPLICA_SET_NAME
          
          security:
            authorization: enabled
          EOF
          
          if [ -n "$KEYFILE_CONTENT" ]; then
            echo "  keyFile: /etc/mongodb-keyfile" >> /etc/mongod.conf
          fi
          
          systemctl restart mongod
          sleep 15
          
          # Test authentication
          if [ "$NODE_INDEX" = "0" ]; then
            echo "Testing authentication on primary..."
            RETRY_COUNT=0
            while [ $RETRY_COUNT -lt 10 ]; do
              if $MONGO_CLI -u "$ADMIN_USERNAME" -p "$ADMIN_PASSWORD" --authenticationDatabase admin --eval "print('Authentication successful!')"; then
                echo "Authentication test passed!"
                break
              fi
              echo "Authentication test failed, retrying... (attempt $((RETRY_COUNT + 1))/10)"
              sleep 10
              RETRY_COUNT=$((RETRY_COUNT + 1))
            done
          
            if [ $RETRY_COUNT -eq 10 ]; then
              echo "ERROR: Authentication test failed after 10 attempts"
              tail -n 20 /data/mongodb/logs/mongod.log
              exit 1
            fi
          
            # Final replica set status check
            echo "Final replica set status:"
            $MONGO_CLI -u "$ADMIN_USERNAME" -p "$ADMIN_PASSWORD" --authenticationDatabase admin --eval "rs.status()" || true
          fi
          
          echo "=== MongoDB setup completed successfully! ==="
          systemctl status mongod --no-pager
          ss -tln | grep 27017

runcmd:
    - bash /opt/mongodb-setup.sh

final_message: "âœ… MongoDB installation and configuration completed!"